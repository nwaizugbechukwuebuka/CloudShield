# ModSecurity WAF Configuration for CloudShield
# Version: 3.0.x
# OWASP ModSecurity Core Rule Set (CRS) v3.3

# ============================================
# Basic Configuration
# ============================================

# Enable ModSecurity engine
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200  # 12.5MB
SecRequestBodyNoFilesLimit 131072  # 128KB
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288  # 512KB
SecResponseBodyLimitAction ProcessPartial

# File upload handling
SecUploadDir /tmp/modsec_upload
SecUploadKeepFiles Off
SecTmpDir /tmp

# Debug logging
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0  # 0=Off, 9=Verbose

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# ============================================
# OWASP CRS Core Rules
# ============================================

# Include OWASP CRS
Include /etc/nginx/modsec/coreruleset/crs-setup.conf
Include /etc/nginx/modsec/coreruleset/rules/*.conf

# ============================================
# Custom Rules for CloudShield
# ============================================

# Rule 1: Block SQL Injection Attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
    "@rx (?i)(\bUNION\b.+\bSELECT\b|\bSELECT\b.+\bFROM\b|\bINSERT\b.+\bINTO\b|\bDELETE\b.+\bFROM\b|\bDROP\b.+\bTABLE\b)" \
    "id:1001,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-sql',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    tag:'cloudshield-custom'"

# Rule 2: Block XSS Attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
    "@rx (?i)(<script[^>]*>|javascript:|onerror\s*=|onload\s*=|<iframe|eval\(|fromCharCode)" \
    "id:1002,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-javascript',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    tag:'cloudshield-custom'"

# Rule 3: Block Command Injection
SecRule ARGS|ARGS_NAMES|REQUEST_BODY \
    "@rx (?i)(;|\||`|\$\(|\$\{|&&|\.\.\/|\/etc\/passwd|\/bin\/bash|nc\s+|wget\s+|curl\s+)" \
    "id:1003,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'Command Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-command-injection',\
    tag:'cloudshield-custom'"

# Rule 4: Block Path Traversal
SecRule REQUEST_URI|REQUEST_BODY|REQUEST_HEADERS|ARGS|ARGS_NAMES \
    "@rx (?i)(\.\.\/|\.\.\\|\/etc\/|\/proc\/|\/sys\/|\/var\/|c:\\|\.\.%2f|\.\.%5c)" \
    "id:1004,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,t:normalizePath,\
    msg:'Path Traversal Attack Detected',\
    severity:WARNING,\
    tag:'attack-path-traversal',\
    tag:'cloudshield-custom'"

# Rule 5: Block SSRF Attempts (Internal IP Access)
SecRule ARGS|REQUEST_BODY \
    "@rx (?i)(https?:\/\/)?(localhost|127\.0\.0\.1|0\.0\.0\.0|::1|169\.254\.|192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.)" \
    "id:1005,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'SSRF Attack Detected - Internal IP Access Attempt',\
    severity:CRITICAL,\
    tag:'attack-ssrf',\
    tag:'cloudshield-custom'"

# Rule 6: Rate Limiting for Authentication Endpoints
SecAction \
    "id:1006,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.auth_attempts=+1,\
    expirevar:ip.auth_attempts=60"

SecRule REQUEST_URI "@beginsWith /auth/login" \
    "chain,\
    id:1007,\
    phase:2,\
    block,\
    msg:'Authentication Rate Limit Exceeded',\
    severity:WARNING,\
    tag:'cloudshield-rate-limit'"
    SecRule IP:AUTH_ATTEMPTS "@gt 20" \
        "t:none"

# Rule 7: Block User-Agent Scanner Signatures
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(nikto|sqlmap|nmap|masscan|nessus|openvas|acunetix|burp|metasploit|w3af|skipfish)" \
    "id:1008,\
    phase:1,\
    block,\
    msg:'Security Scanner Detected',\
    severity:WARNING,\
    tag:'attack-scanner',\
    tag:'cloudshield-custom'"

# Rule 8: Enforce JSON Content-Type for API endpoints
SecRule REQUEST_URI "@beginsWith /api/" \
    "chain,\
    id:1009,\
    phase:2,\
    block,\
    msg:'Invalid Content-Type for API Request',\
    severity:WARNING,\
    tag:'cloudshield-api'"
    SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
        "chain"
    SecRule REQUEST_HEADERS:Content-Type "!@rx ^application/json" \
        "t:none,t:lowercase"

# Rule 9: Block Suspicious File Extensions in Uploads
SecRule FILES_NAMES "@rx (?i)\.(php|asp|aspx|jsp|exe|sh|bat|cmd|ps1|py|rb|pl)$" \
    "id:1010,\
    phase:2,\
    block,\
    msg:'Suspicious File Extension Detected in Upload',\
    severity:CRITICAL,\
    tag:'attack-file-upload',\
    tag:'cloudshield-custom'"

# Rule 10: Block JWT Manipulation Attempts
SecRule REQUEST_HEADERS:Authorization "@rx eyJ[A-Za-z0-9_-]*\.none\." \
    "id:1011,\
    phase:1,\
    block,\
    msg:'JWT None Algorithm Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-jwt',\
    tag:'cloudshield-custom'"

# Rule 11: Block Excessive Request Size (DoS Protection)
SecRule REQUEST_HEADERS:Content-Length "@gt 10485760" \
    "id:1012,\
    phase:1,\
    block,\
    msg:'Request Body Too Large - Possible DoS Attack',\
    severity:WARNING,\
    tag:'attack-dos',\
    tag:'cloudshield-custom'"

# Rule 12: Block NoSQL Injection Attempts
SecRule ARGS|REQUEST_BODY \
    "@rx (?i)(\$ne|\$gt|\$lt|\$or|\$where|\$regex|\{\s*\$)" \
    "id:1013,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'NoSQL Injection Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-nosql-injection',\
    tag:'cloudshield-custom'"

# Rule 13: Require HTTPS (Block HTTP Requests)
SecRule REQUEST_SCHEME "@streq http" \
    "id:1014,\
    phase:1,\
    block,\
    msg:'HTTPS Required - Insecure HTTP Request Blocked',\
    severity:WARNING,\
    tag:'cloudshield-security'"

# Rule 14: Block XML External Entity (XXE) Attacks
SecRule REQUEST_BODY "@rx (?i)(<!DOCTYPE|<!ENTITY|SYSTEM|PUBLIC)" \
    "chain,\
    id:1015,\
    phase:2,\
    block,\
    msg:'XXE Attack Detected',\
    severity:CRITICAL,\
    tag:'attack-xxe',\
    tag:'cloudshield-custom'"
    SecRule REQUEST_HEADERS:Content-Type "@contains xml"

# Rule 15: Whitelist Allowed HTTP Methods
SecRule REQUEST_METHOD "!@within GET HEAD POST PUT PATCH DELETE OPTIONS" \
    "id:1016,\
    phase:1,\
    block,\
    msg:'HTTP Method Not Allowed',\
    severity:WARNING,\
    tag:'cloudshield-method-enforcement'"

# ============================================
# IP Blocklist (Example - Update as needed)
# ============================================

# Block known malicious IPs
SecRule REMOTE_ADDR "@ipMatch 192.0.2.0/24,198.51.100.0/24,203.0.113.0/24" \
    "id:1017,\
    phase:1,\
    block,\
    msg:'Request from Blocked IP Address',\
    severity:CRITICAL,\
    tag:'cloudshield-ip-blocklist'"

# ============================================
# Response Security Headers
# ============================================

# Add security headers to all responses
SecRule REQUEST_URI "@rx .*" \
    "id:1018,\
    phase:3,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942450,\
    setenv:SECURITY_HEADERS=1"

Header always set X-Frame-Options "DENY" env=SECURITY_HEADERS
Header always set X-Content-Type-Options "nosniff" env=SECURITY_HEADERS
Header always set X-XSS-Protection "1; mode=block" env=SECURITY_HEADERS
Header always set Referrer-Policy "strict-origin-when-cross-origin" env=SECURITY_HEADERS
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()" env=SECURITY_HEADERS

# ============================================
# Paranoia Level Configuration
# ============================================

# Set paranoia level (1=Basic, 2=Moderate, 3=High, 4=Extreme)
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=2"

# ============================================
# False Positive Exceptions
# ============================================

# Disable specific rules for legitimate CloudShield API operations
# Example: Allow legitimate JSON payloads that trigger false positives
SecRule REQUEST_URI "@beginsWith /api/integrations" \
    "id:1019,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942450,\
    ctl:ruleRemoveById=942430"

# Allow legitimate OAuth callback URLs
SecRule REQUEST_URI "@beginsWith /auth/callback" \
    "id:1020,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=1005"

# ============================================
# End of Configuration
# ============================================
